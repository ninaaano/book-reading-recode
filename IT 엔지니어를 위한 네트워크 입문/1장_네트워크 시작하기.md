### 목표

- 네트워크 중심
- 물리적 연결
- OSI 7 계층
- 패킷이 실제로 전송되는 인캡슐레이션 (캡슐화) 과정

# 네트워크 구성도 살펴보기

## 홈 네트워크

네트워크는 크게 서비스를 받는 입장, 서비스를 제공하는 입장으로 나뉜다

홈 네트워크 구성은 어떤 인터넷 회선을 연결하더라도 같다

홈 네트워크를 구성하는 데는 모뎀, 공유기, 단말 간에 물리적 연결이 필요하다. 

무선 연결은 무선 랜 카드와 무선 신호를 보낼 수 있는 매체(공기)가 필요하다

유선 연결은 유선 랜 카드(이더넷 랜 카드: 일반적으로 보드에 내장됨), 랜 케이블(랜선)이 필요하다

## 데이터 센터 네트워크

데이터 센터 네트워크는 안정적이고 빠른 대용량 서비스 제공을 목표로 구성한다

10G, 25G, 40,100,400G와 같은 고속 이더넷 기술이 사용 된다

기존에는 3계층 구성이였지만 가상화 기술과 높은 대역폭을 요구하는 스케일 아웃 기반의 애플리케이션과 서비스가 등장하면서 2계층 구성인 스파인-리프 구조로 데이터 센터 네트워크가 변화 되었다

최근에는 10G Base-T 이더넷 포트가 기본적으로 제공되어 TOR(Top of Rack)스위치와 연결되고 리프 스위치인 TOR 스위치는 스파인 스위치와 40,100G로 연결되는 추세다

# 프로토콜

규정이나 규약과 관련된 내용을 언급할 때 프로토콜이라는 용어를 사용한다

- 물리적 측면: 데이터 전송 매체, 신호 규약, 회선 규격 등.이더넷이 널리 쓰인다
- 논리적 측면: 장치들끼리 통신하기 위한 프로토콜 규격, TCP/IP

대부분의 프로토콜이 2진수 비트 기반으로 만들어졌다. 최소한의 비트로 내용을 전송하기 위해서는 서로간의 약속을 정의해야한다. 

애플리케이션 레벨의 프로토콜은 문자 기반 프로토콜이 사용된다. HTTP, SMTP 등 문자 자체를 이용해 헤더와 헤더 값, 데이터를 표현하고 전송한다.

효율성은 비트 기반 프로토콜보다 떨어지지만 다양한 확장이 가능하다

일반적으로 TCP/IP는 프로토콜이라고 부르지 않고 프로토콜 스택이라고 부른다. 총 4개 부분으로 나뉜다

물리 부분 - 이더넷 -> 1계층

데이터가 목적지를 찾아가도록 해줌 - 네트워크 -> 2계층

잘린 패킷을 데이터 형태로 조합하도록 도와줌 - 전송 -> 3계층

애플리케이션 -> 4계층


# OSI 7계층과 TCP/IP

## OSI 7계층

대부분의 프로토콜이 TCP/IP 프로토콜 스택 기반으로 되어 있다

- 1~4계층: 데이터 플로 계층/하위 계층
- 5~7계층: 애플리케이션 계층/상위 계층

데이터 플로 계층은 데이터를 상대방에게 잘 전달하는 역할. 애플리케이션 개발자는 애플리케이션 계층 프로토콜을 개발할 때 하위 데이터 플로 계층을 고려하지 않고 데이터를 표현하는 데 초점을 둔다

애플리케이션 계층은 네트워크 엔지니어들이 심각하게 고려하지 않는다.

이런 이유로 애플리케이션 개발자는 하향식 형식으로 네트워크를 바라보고, 네트워크 엔지니어는 상향식 형식으로 네트워크를 인식한다

## TCP/IP 프로토콜 스택

이론보다 실용성에 중점을 둔 프로토콜이다

OSI 7계층은 데이터 플로 계층과 애플리케이션으로 구분할 수 있는데, 이 구분은 데이터를 만드는 애플리케이션 부분과 데이터를 잘 전달하는데 집중하는 하부 계층으로 구분한다

# OSI 7 계층별 이해하기

## 1계층 (피지컬)

물리계층으로 물리적 연결과 관련된 정보를 정의한다. 주로 전기 신호를 전달하는 데 초점이 맞춰져있다. 허브, 리피터, 케이블, 커넥터, 트랜시버, 탭이 있다

허브, 리피터 - 네트워크 통신을 중재하는 네트워크 장비

케이블, 커넥터 - 케이블 본체를 구성하는 요소

트랜시버 - 컴퓨터의 랜카드와 케이블을 연결

탭 - 네트워크 모니터링과 패킷 분석을 위해 전기 신호를 다른 장비로 복제해준다

전기 신호가 1계층 장비에 들어오면 이 전기 신호를 재생성하여 내보낸다. 1계층 장비는 주소의 개념이 없으므로 전기 신호가 들어온 포트를 제외하고 모든 포트에 같은 전기 신호를 전송한다

## 2계층(데이터링크)

전기 신호를 모아 알아볼 수 있는 데이터 형태로 처리한다. 전기 신호를 정확히 전달하기보다는 주소 정보를 정의하고 정확한 주소로 통신되도록 하는데 초점이 맞춰져있다. 2계층에서는 출발지와 도착지 주소를 확인하고 내게 보낸 것이 맞는지, 처리해야하는지에 대해 검사하고 데이터 처리를 수행한다

주소체계가 생기면서 여러 통신이 한꺼번에 이루어지는 것을 구분하기 위한 기능이 주로 정의된다. 데이터에 대한 에러를 탐지하거나 고치는 역할을 수행할 수 있다. 무작정 데이터를 던지는 것이 아니라 받는 사람이 현재 데이터를 ㅂ다을 수 있는지 확인하는 작업부터 해야하는데, 이 역할을 플로우 컨트롤 이라고 부른다.

2계층에서 동작하는 네트워크 구성 요소는 네트워크 인터페이스 카드, 스위치이다. 2계층의 가장 중요한 특징은 MAC 주소라는 주소 체계가 있다는 것이다. 네트워크 인터페이스 카드와 스위치 모두 MAC 주소를 이해할 수 있고 스위치는 MAC 주소를 보고 통신해야 할 포트를 지정해 내보내는 능력이 있다

네트워크 인터페이스 카드 = 네트워크 인터페이스 컨트롤러 = NIC = 네트워크 카드 = 랜 카드 = 물리 네트워크 인터페이스 = 이더넷 카드 = 네트워크 어댑터

### 네트워크 인터페이스 카드 동작 방식

1. 전기 신호를 데이터 형태로 만든다
2. 목적지 MAC 주소와 출발지 MAC 주소를 확인한다
3. 네트워크 인터페이스 카드의 MAC 주소를 확인한다
4. 목적지 MAC 주소와 네트워크 인터페이스 카드가 갖고 있는 MAC 주소가 맞으면 데이터를 처리하고 다르면 데이터를 폐기한다

네트워크 인터페이스 카드에는 `고유 MAC 주소`가 있다. 입력되는 전기 신호를 데이터 형태로 만들고 데이터에서 도착지 MAC 주소를 확인한 후 자신에게 들어오는 `전기 신호가 맞는지 확인`한다. 아니면 버리고 맞으면 이 데이터를 상위 계층에서 처리할 수 있도록 메모리에 적재한다

스위치는 단말이 어떤 MAC 주소인지, 연결된 포트는 어느 것인지 주소 습득 과정에서 알 수 있다. 이 데이터를 기반으로 `포트를 필터링`하고 `정확한 포트로 포워딩` 해준다.

반면, 1계층의 허브는 한 포트에서 전기 신호가 들어오면 전체 포트로 전기 신호를 전달하다 보니 전체 네트워크에서 동시에 오직 하나의 장비만 데이터를 보낼 수 있다.

스위치의 필터링과 포워딩 기능으로 통신이 필요한 포트만 사용하고 불필요한 처리가 감소되면서 이더넷 효율성이 크게 향상되었다

## 3계층(네트워크 계층)

3계층에서는 주로 IP 주소와 같은 논리적인 주소가 정의된다. 데이터 통신을 할때는 두 가지 주소가 사용되는데 2계층의 물리적인 MAC 주소와 3계층의 논리적인 IP 주소이다. MAC 주소와 달리 IP주소는 사용자가 환경에 맞게 변경해 사용할 수 있고 네트워크 주소 부분과 호스트 주소 부분으로 나뉜다. 3계층을 이해할 수 있는 장비나 단말은 네트워크 주소 정보를 이용해 `자신이 속한 네트워크와 원격지 정보를 구분`하고 원격지 네트워크를 가려면 어디로 가야하는지 `경로를 지정하는 능력`이 있다

- 라우터 - 3계층에서 정의한 IP 주소를 이해할 수 있다. 라우터는 IP 주소를 사용해 최적의 경로를 찾아주고 해당 경로로 패킷을 전송하는 역할을 한다

## 4계층(트랜스포트 계층)

4계층은 실제로 해당 데이터들이 정상적으로 잘 보내지도록 확인하는 역할을 한다.

패킷 네트워크는 데이터를 분할해 패킷에 실어보내다보니 중간에 패킷이 유실되거나 순서가 바뀌는 경우가 생길 수 있는데, 이런 문제를 바로 잡아주는 역할을 4계층이 담당한다.

패킷을 분할할 때 패킷 헤더에 보내는 순서와 받는 순서를 적어 통신하므로 패킷이 유실되면 재전송을 요청할 수 있고 순서가 뒤바껴도 바로잡을 수 있다.

패킷에 보내는 순서를 명시한 것이 `시퀀스 번호` 

받는 순서를 나타낸 것이 `ACK 번호`

장치 내의 애플리케이션을 포트 번호로 사용하여 구분한다

- 로드 밸런서, 방화벽 - 포트 번호와 시퀀스, ACK 번호 정보를 이용해 부하를 분산하거나 보안 정책을 수립해 패킷을 통과, 차단하는 기능을 수행한다

## 5계층(세션 계층)

세션 계층은 양 끝단의 응용 프로세스가 연결을 성립하도록 도와주고 연결이 안정적으로 유지되도록 관리하고 작업 완료 후에는 이 연결을 끊는 역할을 한다.

세션을 관리하는 것이 주요 역할이다. TCP/IP 세션을 만들고 없애는 책임을 지고, 에러로 중단된 통신에 대한 에러 복구와 재전송도 수행한다

## 6계층(프레젠테이션 계층)

표현 방식이 다른 애플리케이션이나 시스템 간의 통신을 돕기 위해 하나의 통일된 구문 형식으로 변환시키는 기능을 수행한다. 

번역기, 변환기 역할을 수행하는 계층이고 이런 기능은 사용자 시스템의 응용 계층에서 데이터 형식 상 차이를 다루는 부담을 덜어준다. MIME 인코딩이나 암호화, 압축, 코드 변환과 같은 동작이 이루어진다

## 7계층(애플리케이션 계층)

애플리케이션 프로세스를 정의하고 애플리케이션 서비스를 수행한다. 네트워크 소프트웨어의 UI 부분이나 사용자 입, 출력 부분을 정의하는 것이 애플리케이션 계층의 역할이다. FTP, SMTP, HTTP, TELNET이 있다

# 인캡슐레이션과 디캡슐레이션

데이터를 보내는 과정 - 인캡슐레이션

받는 과정 - 디캡슐레이션

현대 네트워크는 대부분 패킷 기반 네트워크이다. 패킷 네트워크는 데이터를 패킷이라는 작은 단위로 쪼개 보내는데 이런 기법으로 하나의 통신이 회선 전체를 점유하지 않고 동시에 여러 단말이 통신하도록 해준다. 데이터를 패킷으로 쪼개고 네트워크를 이용해 목적지로 보내고 받는 쪽 에서는 패킷을 다시 큰 데이터 형태로 결합해 사용한다

패킷에 데이터를 넣을 수 있도록 분할하는 과정을 `인캡슐레이션` 이라고 부른다. 적절한 크기로 데이터를 쪼개고 4계층 부터 네트워크 전송을 위한 정보를 헤더에 붙여 넣는다. 헤더 정보는 비트 단위(0또는 1)을 사용한다. 

받는 쪽에서는 `디캡슐레이션` 과정을 수행한다. 받은 전기 신호를 데이터 형태로 만들어 2계층으로 올려보내고 2계층에서 송신자가 작성한 2계층 헤더에 포함된 정보를 확인한다. 만약 2계층에 적힌 정보 중 목적지가 자신이 아니라면 패킷을 버린다. 랜카드가 이 역할을 담당한다. 목적지 정보가 맞다면 3계층으로 이 정보를 보낸다. 데이터를 상위 계층으로 보낼 때는 헤더 정보는 더 이상 필요 없으므로 떼고 올린다

실제 데이터는 상위 계층에서 데이터 플로 계층으로, 즉 상위 계층에서 패킷 형태로 하나씩 인캡슐레이션되면서 내려오고 랜 카드에서 전기 형태로 변환되어 목적지로 전달된다. 이 전기 신호를 받은 목적지에서는 데이터 형태로 변환해 상위 계층으로 올려주고 이 패킷을 조합해 데이터 형태로 만든다.

결국 주고 받는 데이터 흐름을 간단히 표현하면 상위 계층 → 하위 계층, 하위 계층 → 상위 계층으로 전달한다

각 계층에서 인캡슐레이션 과정에서 수행한 것 처럼 현재 계층에 추가하는 헤더 정보는 받는 상대방이 확인해야하는 정보이다. 

- 실제 데이터는 상위 계층 → 하위 계층, 하위 계층 → 상위 계층으로 전달
- 헤더 정보는 각 계층끼리 전달된다

헤더에는 두 가지 정보는 반드시 포함되어야 한다

1. 현재 계층에서 정의하는 정보
2. 상위 프로토콜 지시자

- 4 계층 - 포트 번호
    - 데이터에 순서를 정함
    - 받은 패킷의 순서가 맞는지 확인
    - 빠진 패킷이 없는지 점검
    
    이 정보를 헤더에 적어 넣는다
    
    - TCP에서는 시퀀스, ACK 번호 필드로 이 데이터를 표현한다.
- 3 계층 - 프로토콜 번호
    - 논리적인 주소인 출발지, 도착지 IP 주소를 헤더에 넣는다
- 2 계층 - 이더 타입
    - MAC 주소를 정의
    - 출발지, 도착지 MAC 주소 정보를 헤더에 넣는다

### MSS & MTU

MSS(Maximum Segment Size): 네트워크에서 수용할 수 있는 크기를 역산정해 데이터가 4계층으로 내려올 떄 적절한 크기로 쪼개질 수 있도록 유도하는 값

MTU(Maximum Transmission Unit): 네트워크에서 한 번에 보낼 수 있는 데이터 크기. 1500바이트

이 두가지 모두 데이터 크기를 지칭함. MTU 값은 2계층의 데이터 값, MSS는 4계층에서 가질 수 있는 최대 데이터 값이다.

2계층에서는 2계층 헤더들의 크기를 제외한 데이터 크기를 MTU 크기라고 부른다. IP 헤더와 TCP 헤더의 표준 헤더 크기는 일반적으로 각각 20바이트이므로, 일반 이더넷의 경우 MSS 값을 1460 바이트로 사용한다